language: scala

services:
  - docker

scala:
- 2.12.6

cache:
  directories:
    - $HOME/.sbt
    - $HOME/.ivy2/cache
    - project/target
    - target

branches:
  only:
    - master

jobs:
  include:
   - stage: test
     script:
      - sbt ++$TRAVIS_SCALA_VERSION ";dockerComposeUp;test;dockerComposeStop"

   - stage: check_release_file
     script:
       - python scripts/check_release_file.py

   - stage: release
     script:
       - python scripts/build_and_push_changelog.py
       - if [[ "$?" == "0" ]]; then sbt ++$TRAVIS_SCALA_VERSION release; end

before_script:
  - openssl aes-256-cbc -K $encrypted_12c8071d2874_key -iv $encrypted_12c8071d2874_iv -in secrets.zip.enc -out secrets.zip -d
  - unzip secrets.zip;
  - git config user.name "Travis CI on behalf of Wellcome"
  - git config user.email "wellcomedigitalplatform@wellcome.ac.uk"
  - git config core.sshCommand "ssh -i ssh-key/id_rsa"
  - git remote set-url origin "git@github.com:wellcometrust/scala-storage.git"

stages:
 - test
 - name: check_release_file
   if: type = pull_request
 - name: release
   if: type = push
